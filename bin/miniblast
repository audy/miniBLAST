#!/usr/bin/env ruby
require 'pathname'

LIBRARY_PATH = Pathname.new(__FILE__).realpath.dirname.parent.join('lib').to_s
$:.unshift(LIBRARY_PATH)

require 'dnaio'
require 'searcher'
require 'parallel'

fail "usage: #{__FILE__} database.fasta query.fasta [kmer]" unless ARGV.length == 2
database, query = ARGV
K = 35
searcher = Searcher.new K

File.open(database) do |handle|
  db = DnaIO.new handle
  Parallel.map(db, :in_processes => 16) do |record|
    searcher.add record.sequence, record.name, 
  end
end

File.open(query) do |handle|
  qs = DnaIO.new handle

  Parallel.map(qs, :in_processes => 16) do |chunk|
    hit = searcher.find chunk.sequence
    puts "#{chunk.name} -> #{hit}"
  end
end